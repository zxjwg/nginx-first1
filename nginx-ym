#!/bin/bash

# 设置 NGINX 配置文件路径
NGINX_CONF="/etc/nginx/sites-available/api_proxy"

# 1. 获取用户输入
read -p "请输入新的域名 (例如 api.newdomain.com): " new_domain
read -p "请输入你的邮箱 (可选，直接回车跳过): " email

if [ -z "$new_domain" ]; then
    echo "错误: 域名不能为空。"
    exit 1
fi

echo "--- 正在处理域名: $new_domain ---"

# 2. 修改 NGINX 配置文件中的 server_name
sudo sed -i "s/server_name .*;/server_name $new_domain;/" $NGINX_CONF

# 3. 检查 NGINX 语法并重载
if sudo nginx -t; then
    sudo systemctl reload nginx
else
    echo "错误: NGINX 配置检查失败。"
    exit 1
fi

# 4. 运行 Certbot 申请证书
echo "正在申请 SSL 证书..."
if [ -z "$email" ]; then
    # 如果邮箱为空，使用无邮箱注册标志
    sudo certbot --nginx -d $new_domain --agree-tos --register-unsafely-without-email --redirect --non-interactive
else
    sudo certbot --nginx -d $new_domain --email $email --agree-tos --no-eff-email --redirect --non-interactive
fi

echo "--- 恭喜！域名已更换为: https://$new_domain ---"
