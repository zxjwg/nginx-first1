#!/bin/bash

# 定义路径
NGINX_CONF="/etc/nginx/sites-available/api_proxy"
NGINX_LINK="/etc/nginx/sites-enabled/api_proxy"

# 1. 交互获取输入
read -p "请输入你的域名 (例如 ai.zxj.edu.kg): " new_domain
read -p "请输入你的邮箱 (可选，直接回车跳过): " email

if [ -z "$new_domain" ]; then
    echo "错误: 域名不能为空。"
    exit 1
fi

# 2. 检查并创建基础配置文件
if [ ! -f "$NGINX_CONF" ]; then
    echo "正在创建基础 Nginx 配置文件..."
    sudo bash -c "cat > $NGINX_CONF <<EOF
server {
    listen 80;
    server_name $new_domain;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_buffering off;
        proxy_read_timeout 300s;
    }
}
EOF"
fi

# 3. 确保建立了软链接
if [ ! -L "$NGINX_LINK" ]; then
    echo "正在建立 Nginx 软链接..."
    sudo ln -s $NGINX_CONF $NGINX_LINK
fi

# 4. 修改域名（以防文件已存在但域名不对）
sudo sed -i "s/server_name .*;/server_name $new_domain;/" $NGINX_CONF

# 5. 检查 Nginx 语法
if sudo nginx -t; then
    sudo systemctl reload nginx
else
    echo "错误: Nginx 配置语法检查失败，请检查输出信息。"
    exit 1
fi

# 6. 申请 SSL 证书
echo "正在向 Let's Encrypt 申请 SSL 证书..."
if [ -z "$email" ]; then
    sudo certbot --nginx -d $new_domain --agree-tos --register-unsafely-without-email --redirect --non-interactive
else
    sudo certbot --nginx -d $new_domain --email $email --agree-tos --no-eff-email --redirect --non-interactive
fi

echo "------------------------------------------------"
echo "恭喜！站点已成功部署至: https://$new_domain"
echo "后端已指向本地 3000 端口 (New API)"
echo "------------------------------------------------"
