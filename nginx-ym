#!/bin/bash

# å®šä¹‰é…ç½®è·¯å¾„
NGINX_CONF="/etc/nginx/sites-available/api_proxy"
NGINX_LINK="/etc/nginx/sites-enabled/api_proxy"

echo "=== ZXJ AI å•†ä¸šå¹³å°ä¸€é”®éƒ¨ç½²è„šæœ¬ ==="

# 1. äº¤äº’èŽ·å–è¾“å…¥
read -p "è¯·è¾“å…¥ä½ çš„åŸŸå (ä¾‹å¦‚ ai.zxj.edu.kg): " new_domain
read -p "è¯·è¾“å…¥ä½ çš„é‚®ç®± (ç›´æŽ¥å›žè½¦åˆ™è·³è¿‡): " email

if [ -z "$new_domain" ]; then
    echo "é”™è¯¯: åŸŸåä¸èƒ½ä¸ºç©ºã€‚"
    exit 1
fi

# 2. æ£€æŸ¥å¹¶å®‰è£…å¿…è¦è½¯ä»¶
echo "æ­£åœ¨æ£€æŸ¥çŽ¯å¢ƒ..."
sudo apt update && sudo apt install -y nginx certbot python3-certbot-nginx

# 3. å¦‚æžœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæ ‡å‡†æ¨¡æ¿
if [ ! -f "$NGINX_CONF" ]; then
    echo "æ­£åœ¨åˆå§‹åŒ– Nginx é…ç½®..."
    sudo bash -c "cat > $NGINX_CONF <<EOF
server {
    listen 80;
    server_name $new_domain;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_buffering off;
        proxy_read_timeout 300s;
    }
}
EOF"
fi

# 4. ç¡®ä¿å»ºç«‹äº† Nginx è½¯é“¾æŽ¥
if [ ! -L "$NGINX_LINK" ]; then
    echo "æ­£åœ¨å¯ç”¨é…ç½®..."
    sudo ln -s $NGINX_CONF $NGINX_LINK
fi

# 5. æ›´æ–°åŸŸåï¼ˆç¡®ä¿ sed æ­£å¸¸å·¥ä½œï¼‰
sudo sed -i "s/server_name .*;/server_name $new_domain;/" $NGINX_CONF

# 6. æ£€æŸ¥ Nginx è¯­æ³•å¹¶é‡è½½
if sudo nginx -t; then
    sudo systemctl reload nginx
else
    echo "é”™è¯¯: Nginx é…ç½®æ£€æŸ¥å¤±è´¥ã€‚"
    exit 1
fi

# 7. ç”³è¯· SSL è¯ä¹¦
echo "æ­£åœ¨å‘ Let's Encrypt ç”³è¯· SSL è¯ä¹¦..."
if [ -z "$email" ]; then
    sudo certbot --nginx -d $new_domain --agree-tos --register-unsafely-without-email --redirect --non-interactive
else
    sudo certbot --nginx -d $new_domain --email $email --agree-tos --no-eff-email --redirect --non-interactive
fi

echo "================================================"
echo "ðŸŽ‰ æ­å–œï¼ç«™ç‚¹å·²æˆåŠŸéƒ¨ç½²è‡³: https://$new_domain"
echo "åŽç«¯å·²æŒ‡å‘æœ¬åœ° 3000 ç«¯å£ï¼Œè¯·ç¡®ä¿ New API å®¹å™¨å·²å¯åŠ¨ã€‚"
echo "================================================"
